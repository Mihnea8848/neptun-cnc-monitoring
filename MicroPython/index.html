<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Control</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem 0; }
        h1 { color: #333; margin-bottom: 1rem; width: 100%; text-align: center; }
        .page-wrapper { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; }
        .form-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; width: 100%; }
        .container { background-color: #ffffff; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); flex: 1; min-width: 320px; max-width: 400px; }
        h2 { text-align: center; margin-top: 0; margin-bottom: 1.5rem; color: #444; }
        #status-container { font-size: 1.2rem; font-weight: bold; margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        #status-text.online { color: #28a745; }
        #status-text.offline { color: #dc3545; }
        #status-text.error { color: #dc3545; }
        form { display: flex; flex-direction: column; gap: 1.2rem; }
        .form-row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        label { font-weight: bold; color: #555; white-space: nowrap; }
        input { padding: 0.8rem; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; width: 60%; box-sizing: border-box; }
        button { padding: 1rem; border: none; border-radius: 5px; background-color: #007bff; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; margin-top: 1rem; width: 100%; }
        button:hover { background-color: #0056b3; }
        button.waiting { background-color: #555; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <h1>ESP32 Monitoring System</h1>
        <form id="config-form" action="/" method="get">
            <div class="form-container">
                <div class="container">
                    <h2>System Status & Wi-Fi</h2>
                    <div id="status-container"> CNC Lave Status: <span id="status-text">...loading...</span> </div>
                    <div class="form-row"> <label for="ssid">Network SSID</label> <input type="text" id="ssid" name="ssid" placeholder="Required"> </div>
                    <div class="form-row"> <label for="password">Network Password</label> <input type="password" id="password" name="password" placeholder="Required"> </div>
                    <div class="form-row"> <label for="ip">Static IP (Optional)</label> <input type="text" id="ip" name="ip" placeholder="e.g., 192.168.1.55"> </div>
                </div>
                <div class="container">
                    <h2>MQTT Configuration</h2>
                    <div class="form-row"> <label for="mqtt_broker">Broker IP Address</label> <input type="text" id="mqtt_broker" name="mqtt_broker"> </div>
                    <div class="form-row"> <label for="mqtt_port">Port</label> <input type="number" id="mqtt_port" name="mqtt_port" placeholder="1883"> </div>
                    <div class="form-row"> <label for="mqtt_topic">Topic</label> <input type="text" id="mqtt_topic" name="mqtt_topic" placeholder="e.g., cnc/status"> </div>
                    <div class="form-row"> <label for="mqtt_interval">Send Interval (s)</label> <input type="number" id="mqtt_interval" name="mqtt_interval" placeholder="e.g., 30"> </div>
                </div>
            </div>
            <button type="submit" id="submit-button">Save All and Reboot</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const statusElement = document.getElementById('status-text');
            const form = document.getElementById('config-form');
            const ssidInput = document.getElementById('ssid');
            const passwordInput = document.getElementById('password');
            const submitButton = document.getElementById('submit-button');

            // --- NEW: Function to fetch and populate config ---
            function fetchConfig() {
                fetch('/config')
                    .then(response => response.json())
                    .then(data => {
                        // Populate form fields with the received data
                        document.getElementById('ssid').value = data.ssid || '';
                        document.getElementById('ip').value = data.ip || '';
                        document.getElementById('mqtt_broker').value = data.mqtt_broker || '';
                        document.getElementById('mqtt_port').value = data.mqtt_port || '';
                        document.getElementById('mqtt_topic').value = data.mqtt_topic || '';
                        document.getElementById('mqtt_interval').value = data.mqtt_interval || '';
                        // Do not populate the password field for security
                    })
                    .catch(error => console.error('Error fetching config:', error));
            }

            function fetchStatus() {
                fetch('/status').then(r => r.json()).then(data => {
                    const status = data.status || 'ERROR';
                    statusElement.textContent = status;
                    statusElement.classList.remove('online', 'offline', 'error');
                    statusElement.classList.add(status.toLowerCase());
                }).catch(error => {
                    console.error('Error fetching status:', error);
                    statusElement.textContent = 'ERROR';
                    statusElement.classList.add('error');
                });
            }

            // --- Run all startup functions ---
            fetchStatus();
            fetchConfig();
            setInterval(fetchStatus, 3000);

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                ssidInput.style.border = '1px solid #ccc';
                passwordInput.style.border = '1px solid #ccc';
                const ssid = ssidInput.value.trim();
                const password = passwordInput.value.trim();

                // If SSID has not changed from original, password is not required.
                // This is a simple check; a better way would be to compare with fetched config.
                // But for now, we assume if the password field is empty, they don't want to change it.
                if (ssid === '' ) {
                    alert('Network SSID cannot be empty.');
                    ssidInput.style.border = '2px solid red';
                    ssidInput.focus();
                    return;
                }

                submitButton.textContent = 'Scanning...';
                submitButton.classList.add('waiting');
                submitButton.disabled = true;

                fetch(`/scan?ssid=${encodeURIComponent(ssid)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.found) {
                            submitButton.textContent = 'SSID Found! Rebooting...';
                            const formData = new URLSearchParams(new FormData(form)).toString();
                            window.location.href = `/?${formData}`;
                        } else {
                            alert(`Error: Network SSID "${ssid}" not found.`);
                            ssidInput.style.border = '2px solid red';
                            ssidInput.focus();
                            submitButton.textContent = 'Save All and Reboot';
                            submitButton.classList.remove('waiting');
                            submitButton.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error during SSID scan:', error);
                        alert('An error occurred while scanning for networks.');
                        submitButton.textContent = 'Save All and Reboot';
                        submitButton.classList.remove('waiting');
                        submitButton.disabled = false;
                    });
            });
        });
    </script>
</body>
</html>